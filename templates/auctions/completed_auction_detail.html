{% extends 'base.html' %}

{% block title %}{{ auction.title }} - Detailed History{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">
                <i class="fas fa-trophy text-success me-2"></i>{{ auction.title }}
            </h1>
            <p class="text-muted mb-0">
                <strong>Auction ID:</strong> {{ auction.id }}<br>
                <strong>Created by:</strong> {{ auction.created_by.username }} • 
                <strong>Completed:</strong> {{ auction.end_time|date:"M d, Y H:i" }}
            </p>
        </div>
        <a href="{% url 'auctions:completed-auctions' %}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>

    <!-- Auction Summary -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Auction Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Financial Details</h6>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Start Price:</small><br>
                                    <strong>₹{{ auction.start_price }}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Final Price:</small><br>
                                    <strong class="text-success fs-5">₹{{ auction.current_price }}</strong>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Max Bid Limit:</small><br>
                                    <span>₹{{ auction.max_bid }}</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Price Increase:</small><br>
                                    <span class="text-success">
                                        +₹{{ auction.price_increase_amount }}
                                        ({{ auction.price_increase_percentage|floatformat:1 }}%)
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Timing & Duration</h6>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <small class="text-muted">Planned Duration:</small><br>
                                    <span>{{ auction.duration }}s</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Actual Duration:</small><br>
                                    <span>{{ auction.actual_duration|floatformat:0 }}s</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <small class="text-muted">Started:</small><br>
                                    <span>{{ auction.start_time|date:"M d, Y H:i:s" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Winner & Stats -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-crown me-2"></i>Winner</h5>
                </div>
                <div class="card-body text-center">
                    {% if auction.get_winner_display != "No winner" %}
                        <i class="fas fa-trophy fa-3x text-warning mb-3"></i>
                        <h4 class="text-warning">{{ auction.get_winner_display }}</h4>
                        <p class="text-muted">Won with ₹{{ auction.current_price }}</p>
                    {% else %}
                        <i class="fas fa-times-circle fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No Winner</h4>
                        <p class="text-muted">Auction ended without bids</p>
                    {% endif %}
                </div>
            </div>

            <!-- Bidding Statistics -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Bidding Stats</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h3 class="text-primary">{{ auction.total_bids }}</h3>
                            <small class="text-muted">Total Bids</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-info">{{ auction.human_bids_count }}</h3>
                            <small class="text-muted">Human</small>
                        </div>
                        <div class="col-4">
                            <h3 class="text-secondary">{{ auction.bot_bids_count }}</h3>
                            <small class="text-muted">Bot</small>
                        </div>
                    </div>
                    
                    <!-- Phase Breakdown -->
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="text-center mb-3">Bids by Phase</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <span class="badge bg-primary">{{ phase_stats.1 }}</span><br>
                                <small>Phase 1</small>
                            </div>
                            <div class="col-4">
                                <span class="badge bg-info">{{ phase_stats.2 }}</span><br>
                                <small>Phase 2</small>
                            </div>
                            <div class="col-4">
                                <span class="badge bg-warning">{{ phase_stats.3 }}</span><br>
                                <small>Phase 3</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bidder Participation -->
    {% if unique_bidders %}
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-users me-2"></i>Bidder Participation</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Bidder</th>
                            <th>Type</th>
                            <th>Total Bids</th>
                            <th>Highest Bid</th>
                            <th>Total Amount Bid</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bidder in unique_bidders %}
                            <tr>
                                <td>
                                    {% if bidder.bidder_type == 'human' %}
                                        <i class="fas fa-user text-primary me-2"></i>{{ bidder.bidder__username }}
                                    {% else %}
                                        <i class="fas fa-robot text-secondary me-2"></i>Bot
                                    {% endif %}
                                </td>
                                <td>
                                    {% if bidder.bidder_type == 'human' %}
                                        <span class="badge bg-primary">Human</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Bot</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-info">{{ bidder.bid_count }}</span></td>
                                <td><strong>₹{{ bidder.max_bid }}</strong></td>
                                <td>₹{{ bidder.total_amount }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Complete Bid History -->
    <div class="card shadow-sm">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Complete Bid History</h5>
        </div>
        <div class="card-body">
            {% if auction.bid_history %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Time</th>
                                <th>Bidder</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Phase</th>
                                <th>Time from Start</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bid in auction.bid_history %}
                                <tr {% if bid.amount == auction.current_price %}class="table-warning"{% endif %}>
                                    <td><strong>{{ forloop.counter }}</strong></td>
                                    <td>
                                        <small>{{ bid.timestamp|date:"H:i:s" }}</small>
                                    </td>
                                    <td>
                                        {% if bid.bidder_type == 'human' %}
                                            <i class="fas fa-user text-primary me-1"></i>{{ bid.bidder.username }}
                                        {% else %}
                                            <i class="fas fa-robot text-secondary me-1"></i>Bot
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bid.bidder_type == 'human' %}
                                            <span class="badge bg-primary">Human</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Bot</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>₹{{ bid.amount }}</strong>
                                        {% if bid.amount == auction.current_price %}
                                            <i class="fas fa-crown text-warning ms-2" title="Winning bid"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">Phase {{ bid.phase }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            +{{ bid.timestamp|timesince:auction.start_time|slice:":5" }}
                                        </small>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Bids</h4>
                    <p class="text-muted">No bids were placed in this auction.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center mt-4">
        <a href="{% url 'auctions:auction-detail' auction.id %}" class="btn btn-outline-primary me-2">
            <i class="fas fa-eye me-2"></i>View Live Auction Page
        </a>
        <a href="{% url 'auctions:completed-auctions' %}" class="btn btn-secondary">
            <i class="fas fa-list me-2"></i>Back to All Completed
        </a>
    </div>
</div>

<style>
.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    transform: translateY(-2px);
    transition: all 0.3s ease;
}
</style>
{% endblock %}
